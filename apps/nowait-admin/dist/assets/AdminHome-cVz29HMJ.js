import{j as e,r as c}from"./index-D0dnNxI7.js";import{r as X}from"./refresh-CZIaawOm.js";import{C as Y,a as ee}from"./closeButton-6cbDW4kB.js";import{u as H}from"./useQuery-CCwnVFBg.js";import{A as F}from"./AdminApi-BnHrq_k2.js";import{u as W}from"./useMutation-c0hQv--K.js";import{u as te,T as se}from"./useGetStore-Dj3CrBej.js";import"./close-Pq4fSto9.js";function Z(t){var a,i,r="";if(typeof t=="string"||typeof t=="number")r+=t;else if(typeof t=="object")if(Array.isArray(t)){var m=t.length;for(a=0;a<m;a++)t[a]&&(i=Z(t[a]))&&(r&&(r+=" "),r+=i)}else for(i in t)t[i]&&(r&&(r+=" "),r+=i);return r}function ae(){for(var t,a,i=0,r="",m=arguments.length;i<m;i++)(t=arguments[i])&&(a=Z(t))&&(r&&(r+=" "),r+=a);return r}const ne=({label:t,active:a=!1,onClick:i,count:r})=>e.jsxs("button",{onClick:i,className:ae("px-4 h-[33px] rounded-full text-14-semibold transition cursor-pointer mr-[6px]","whitespace-nowrap",a?"bg-black text-white":"bg-white text-black-60"),children:[t,r!==void 0&&r>0&&e.jsxs("span",{children:[" ",`${r}`]})]}),ie="data:image/svg+xml,%3csvg%20width='20'%20height='20'%20viewBox='0%200%2020%2020'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cmask%20id='mask0_569_407'%20style='mask-type:alpha'%20maskUnits='userSpaceOnUse'%20x='0'%20y='0'%20width='20'%20height='20'%3e%3crect%20width='20'%20height='20'%20fill='%23D9D9D9'/%3e%3c/mask%3e%3cg%20mask='url(%23mask0_569_407)'%3e%3cpath%20d='M3.69922%2013.916L5.25%2013.916M15.7992%2013.916L14.4715%2013.916M7.54922%2016.996H11.9492M5.25%2013.916V7.52678C5.25%204.98032%207.31431%202.91602%209.86076%202.91602V2.91602C12.4072%202.91602%2014.4715%204.98032%2014.4715%207.52678V8.41602V13.916M5.25%2013.916H14.4715'%20stroke='%23FF6736'%20stroke-width='1.66667'%20stroke-linecap='round'/%3e%3c/g%3e%3c/svg%3e",q="data:image/svg+xml,%3csvg%20width='20'%20height='20'%20viewBox='0%200%2020%2020'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cmask%20id='mask0_569_413'%20style='mask-type:alpha'%20maskUnits='userSpaceOnUse'%20x='0'%20y='0'%20width='20'%20height='20'%3e%3crect%20width='20'%20height='20'%20fill='%23D9D9D9'/%3e%3c/mask%3e%3cg%20mask='url(%23mask0_569_413)'%3e%3cpath%20d='M9.15635%2010.8389C9.3908%2010.8389%209.59003%2010.7584%209.75406%2010.5973C9.91823%2010.4362%2010.0003%2010.2383%2010.0003%2010.0037C10.0003%209.76928%209.91976%209.56997%209.75865%209.40581C9.5974%209.24178%209.39955%209.15977%209.1651%209.15977C8.93052%209.15977%208.73122%209.24032%208.56719%209.40143C8.40302%209.56254%208.32094%209.76039%208.32094%209.99497C8.32094%2010.2294%208.40156%2010.4287%208.56281%2010.5929C8.72392%2010.7569%208.92177%2010.8389%209.15635%2010.8389ZM6.0651%2017.1379V15.4346L10.9057%2014.4596V6.50122C10.9057%206.24497%2010.8211%206.01581%2010.652%205.81372C10.483%205.61164%2010.2655%205.47956%209.99948%205.41747L6.0651%204.60893V2.88477L10.3718%203.68331C11.0352%203.80734%2011.5783%204.13789%2012.0009%204.67497C12.4236%205.2122%2012.6349%205.82095%2012.6349%206.50122V14.4464C12.6349%2014.8621%2012.4986%2015.2288%2012.2259%2015.5464C11.9533%2015.8641%2011.6082%2016.0626%2011.1905%2016.1421L6.0651%2017.1379ZM6.0651%2015.4346H13.9355V4.61393L6.0651%204.60893V15.4346ZM3.70052%2017.1637C3.45816%2017.1637%203.25344%2017.0807%203.08635%2016.9146C2.91941%2016.7483%202.83594%2016.5446%202.83594%2016.3035C2.83594%2016.0624%202.91941%2015.8573%203.08635%2015.6883C3.25344%2015.5191%203.45816%2015.4346%203.70052%2015.4346H4.33594V4.61393C4.33594%204.13504%204.50441%203.72713%204.84135%203.39018C5.1783%203.05324%205.58622%202.88477%206.0651%202.88477H13.9355C14.4144%202.88477%2014.8223%203.05324%2015.1593%203.39018C15.4962%203.72713%2015.6647%204.13504%2015.6647%204.61393V15.4346H16.2957C16.5368%2015.4346%2016.742%2015.5176%2016.9111%2015.6837C17.0802%2015.85%2017.1647%2016.0537%2017.1647%2016.2948C17.1647%2016.5359%2017.0812%2016.741%2016.9143%2016.9102C16.7472%2017.0792%2016.5425%2017.1637%2016.3001%2017.1637H3.70052Z'%20fill='%232C7CF6'/%3e%3c/g%3e%3c/svg%3e",le="data:image/svg+xml,%3csvg%20width='16'%20height='16'%20viewBox='0%200%2016%2016'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M8.83333%207.66667V4.66667C8.83333%204.43056%208.75347%204.23264%208.59375%204.07292C8.43403%203.91319%208.23611%203.83333%208%203.83333C7.76389%203.83333%207.56597%203.91319%207.40625%204.07292C7.24653%204.23264%207.16667%204.43056%207.16667%204.66667V7.97917C7.16667%208.09028%207.1875%208.19792%207.22917%208.30208C7.27083%208.40625%207.33333%208.5%207.41667%208.58333L9.75%2010.9167C9.90278%2011.0694%2010.0972%2011.1458%2010.3333%2011.1458C10.5694%2011.1458%2010.7639%2011.0694%2010.9167%2010.9167C11.0694%2010.7639%2011.1458%2010.5694%2011.1458%2010.3333C11.1458%2010.0972%2011.0694%209.90278%2010.9167%209.75L8.83333%207.66667ZM8%2015.5C6.95833%2015.5%205.98264%2015.3021%205.07292%2014.9062C4.16319%2014.5104%203.37153%2013.9757%202.69792%2013.3021C2.02431%2012.6285%201.48958%2011.8368%201.09375%2010.9271C0.697917%2010.0174%200.5%209.04167%200.5%208C0.5%206.95833%200.697917%205.98264%201.09375%205.07292C1.48958%204.16319%202.02431%203.37153%202.69792%202.69792C3.37153%202.02431%204.16319%201.48958%205.07292%201.09375C5.98264%200.697917%206.95833%200.5%208%200.5C9.04167%200.5%2010.0174%200.697917%2010.9271%201.09375C11.8368%201.48958%2012.6285%202.02431%2013.3021%202.69792C13.9757%203.37153%2014.5104%204.16319%2014.9062%205.07292C15.3021%205.98264%2015.5%206.95833%2015.5%208C15.5%209.04167%2015.3021%2010.0174%2014.9062%2010.9271C14.5104%2011.8368%2013.9757%2012.6285%2013.3021%2013.3021C12.6285%2013.9757%2011.8368%2014.5104%2010.9271%2014.9062C10.0174%2015.3021%209.04167%2015.5%208%2015.5ZM8%2013.8333C9.625%2013.8333%2011.0035%2013.2674%2012.1354%2012.1354C13.2674%2011.0035%2013.8333%209.625%2013.8333%208C13.8333%206.375%2013.2674%204.99653%2012.1354%203.86458C11.0035%202.73264%209.625%202.16667%208%202.16667C6.375%202.16667%204.99653%202.73264%203.86458%203.86458C2.73264%204.99653%202.16667%206.375%202.16667%208C2.16667%209.625%202.73264%2011.0035%203.86458%2012.1354C4.99653%2013.2674%206.375%2013.8333%208%2013.8333Z'%20fill='%23888888'/%3e%3c/svg%3e",re=10,oe=(t,a=3)=>(t==null?void 0:t.length)>a?t.slice(0,a)+"...":t,_=(t,a)=>!t||!a?0:Math.floor((new Date(a).getTime()-new Date(t).getTime())/6e4),ce=(t,a)=>t.number===a.number&&t.time===a.time&&t.waitMinutes===a.waitMinutes&&t.peopleCount===a.peopleCount&&t.name===a.name&&t.phoneNumber===a.phoneNumber&&t.status===a.status&&t.requestedAt===a.requestedAt&&t.calledAt===a.calledAt&&t.confirmedAt===a.confirmedAt&&t.cancelledAt===a.cancelledAt&&t.isNoShow===a.isNoShow,de=c.memo(function({number:a,time:i,waitMinutes:r,peopleCount:m,name:g,phoneNumber:y,status:l,requestedAt:p,calledAt:C,confirmedAt:u,cancelledAt:x,isNoShow:w,onCall:A,onEnter:h,onClose:k,onNoShow:b,onDelete:N}){const[S,j]=c.useState("10:00");return console.log(i,"카드 생성 시간?"),c.useEffect(()=>{if(l==="CALLING"&&C){const L=new Date(C).getTime(),I=()=>{const D=Date.now(),T=Math.floor((D-L)/1e3),v=Math.max(re-T,0),O=String(Math.floor(v/60)).padStart(2,"0"),$=String(v%60).padStart(2,"0");j(`${O}:${$}`),v===0&&b()};I();const R=setInterval(I,1e3);return()=>clearInterval(R)}},[l,C]),e.jsxs("div",{className:"w-full relative h-[200px] bg-white rounded-[16px] px-6 py-[18px]  ",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("p",{className:"text-20-bold text-black-80",children:["#",a<10?`0${a}`:a,"번"]}),e.jsxs("div",{className:"flex items-center text-13-medium text-black-50",children:[e.jsx("span",{children:l==="CONFIRMED"&&u?`${new Date(new Date(u).getTime()+540*60*1e3).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit",hour12:!1})}`:l==="CANCELLED"&&x?`${new Date(new Date(x).getTime()+540*60*1e3).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit",hour12:!1})}`:i}),e.jsx("span",{className:"px-[2px]",children:"·"}),e.jsx("span",{children:l==="CONFIRMED"&&u?`${_(p,new Date(new Date(u).getTime()+540*60*1e3).toString())}분 대기`:l==="CANCELLED"&&x?`${_(p,new Date(new Date(x).getTime()+540*60*1e3).toString())}분 대기`:`${r}분 대기 중`}),(l==="WAITING"||l==="CALLING")&&e.jsx(Y,{onClick:N})]})]}),e.jsxs("div",{className:"flex justify-between text-left rounded-lg overflow-hidden mb-4",children:[e.jsxs("div",{className:"flex flex-col py-2 w-[15%]",children:[e.jsx("div",{className:"text-14-medium text-black-60 mb-1",children:"인원"}),e.jsxs("div",{className:"text-17-bold text-black-85",children:[m,"명"]})]}),e.jsx("div",{className:"w-px bg-black-10 mr-[5%]"}),e.jsxs("div",{className:"flex flex-col py-2 w-[25%]",children:[e.jsx("div",{className:"text-14-medium text-black-60 mb-1",children:"이름"}),e.jsx("div",{className:"text-17-bold text-black-85",children:oe(g)})]}),e.jsx("div",{className:"w-px bg-black-10 mr-[5%]"}),e.jsxs("div",{className:"flex flex-col py-2 w-[50%]",children:[e.jsx("div",{className:"text-14-medium text-black-60 mb-1",children:"전화번호"}),e.jsx("div",{className:"text-17-bold text-black-85",children:y===""?"010-****-****":y})]})]}),e.jsxs("div",{className:"flex justify-center gap-[8px]",children:[l==="WAITING"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:A,className:"w-[60%] bg-[#FFF0EB] py-2 rounded-[8px] flex justify-center items-center gap-1",children:[e.jsx("img",{src:ie})," ",e.jsx("span",{className:"text-[#FF6736] text-15-semibold",children:"호출"})]}),e.jsxs("button",{onClick:h,className:"w-[35%] bg-[#E8F3FF] text-15-semibold text-[#2C7CF6] py-2 rounded-[8px] flex justify-center items-center gap-1",children:[e.jsx("img",{src:q})," 입장"]})]}),l==="CALLING"&&(w===!0?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:k,className:"w-[60%] bg-black-30 text-black-80 text-15-semibold rounded-[8px] flex justify-center items-center py-2",children:"미입장"}),e.jsxs("button",{onClick:h,className:"w-[35%] bg-[#E8F3FF] text-[#2C7CF6] text-15-semibold py-2 rounded-[8px] flex justify-center items-center gap-1",children:[e.jsx("img",{src:q})," 입장"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-[60%] bg-black-15 text-black-60 text-15-semibold py-2 rounded-[8px] flex justify-center items-center gap-1",children:[e.jsx("img",{src:le})," ",e.jsx("span",{children:S})]}),e.jsx("button",{onClick:h,className:"w-[35%] bg-[#E8F3FF] text-[#2C7CF6] text-15-semibold py-2 rounded-[8px] flex justify-center items-center gap-1",children:"입장"})]})),l==="CANCELLED"&&e.jsx("div",{className:"w-full bg-black-5 text-black-40 text-15-semibold rounded-[8px] flex justify-center items-center py-2",children:"취소된 입장"}),l==="CONFIRMED"&&e.jsx("div",{className:"w-full bg-black-5 text-black-40 text-15-semibold rounded-[8px] flex justify-center items-center py-2",children:"완료된 입장"})]})]})},ce),ue=async t=>(await F.get(`/reservations/admin/${t}/waiting/users`)).data.response,me=t=>H({queryKey:["reservations",t],queryFn:()=>{if(t===null)throw new Error("storeId is null");return ue(t)},enabled:t!==null}),xe=()=>W({mutationFn:async({storeId:t,reservationNumber:a,status:i})=>(await F.patch(`/reservations/admin/update/${t}/${a}`,{status:i})).data}),he=async t=>(await F.get(`/reservations/admin/${t}/completed`)).data.response,fe=t=>H({queryKey:["completed",t],queryFn:()=>{if(t===null)throw new Error("storeId is null");return he(t)},enabled:t!==null}),ge=()=>W({mutationFn:async t=>(await F.patch(`/admin/stores/toggle-active/${t}`)).data.response}),Ae=()=>{const[t,a]=c.useState([]),{mutate:i}=xe(),[r,m]=c.useState(!1),[g,y]=c.useState("전체"),l=Number(localStorage.getItem("storeId")),[p,C]=c.useState(null),[u,x]=c.useState([]),[w,A]=c.useState(null),[h,k]=c.useState(!1),{data:b}=te(l),{data:N,refetch:S}=me(l),{data:j,refetch:L}=fe(l),{mutate:I}=ge(),R=()=>{I(l,{onSuccess:s=>{C(s)},onError:()=>{alert("활성화 상태 변경 실패")}})},D=u.filter(s=>s.status==="WAITING").length;localStorage.setItem("waitingCount",D.toString());const T=u.filter(s=>s.status==="CALLING").length,v=u.filter(s=>s.status==="CONFIRMED").length,O=u.filter(s=>s.status==="CANCELLED").length,$=[{label:"전체"},{label:"대기 중",count:D},{label:"호출 중",count:T},{label:"입장 완료",count:v},{label:"대기 취소",count:O}],B={WAITING:"대기 중",CALLING:"호출 중",CONFIRMED:"입장 완료",CANCELLED:"대기 취소"},K=c.useMemo(()=>{var f;const s=[...u].sort((d,n)=>d.id-n.id);if(g==="전체")return u;const o=(f=Object.entries(B).find(([,d])=>d===g))==null?void 0:f[0];return o?s.filter(d=>d.status===o):[]},[u,g]),U=c.useCallback((s,o)=>{i({storeId:l,reservationNumber:o,status:"CALLING"},{onSuccess:()=>{x(f=>f.map(d=>d.id===s?{...d,status:"CALLING",calledAt:new Date().toISOString(),confirmedAt:void 0,cancelledAt:void 0}:d))}})},[l,i]),z=c.useCallback((s,o)=>{const f=new Date().toISOString();i({storeId:l,reservationNumber:o,status:"CONFIRMED"},{onSuccess:()=>{x(d=>d.map(n=>n.id!==s?n:{...n,status:"CONFIRMED",confirmedAt:f}))}})},[l,i]),V=c.useCallback((s,o)=>{const f=new Date().toISOString();i({storeId:l,reservationNumber:o,status:"CANCELLED"},{onSuccess:()=>{x(d=>d.map(n=>n.id!==s?n:{...n,status:"CANCELLED",cancelledAt:f}))}})},[l,i]),P=c.useCallback(s=>{a(o=>o.includes(s)?o:[...o,s])},[]),Q=c.useCallback(async()=>{if(!h){k(!0);try{await Promise.all([S(),L()])}finally{setTimeout(()=>k(!1),300)}}},[h,S,L]);return c.useEffect(()=>{if(!Array.isArray(N)||!Array.isArray(j))return;const s=Date.now(),o=n=>{console.log(n,"현재 데이터");const E=new Date(n.createdAt??""),M=n.calledAt&&!isNaN(Date.parse(n.calledAt))?new Date(n.calledAt):void 0,J=parseInt(n.reservationNumber.slice(-4),10);return{id:Number(J),userId:Number(n.userId),reservationNumber:n.reservationNumber,requestedAt:n.createdAt,time:E.toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit",hour12:!0}),waitMinutes:Math.floor((s-E.getTime())/6e4),peopleCount:n.partySize,name:n.userName,phoneNumber:n.phoneNumber,status:n.status,calledAt:n.status==="CALLING"&&M?M.toISOString():void 0,updatedAt:n.updatedAt}},d=[...N,...j].map(o).filter((n,E,G)=>E===G.findIndex(M=>M.reservationNumber===n.reservationNumber));x(d)},[N,j]),c.useEffect(()=>{b&&C(b.isActive)},[b]),e.jsxs("div",{className:"w-full flex flex-col items-center space-y-6",children:[e.jsx("section",{id:"대기 현황",className:"flex w-full [@media(min-width:375px)_and_(max-width:431px)]:justify-center m-0",children:e.jsx("div",{className:"flex flex-col w-full",children:e.jsxs("div",{className:"flex items-center justify-between mb-[30px]",children:[e.jsxs("div",{className:"flex items-baseline space-x-[6px]",children:[e.jsx("h1",{className:"text-title-20-bold",children:"대기 접수"}),e.jsx("span",{className:`text-title-20-bold transition-all duration-700 ${p?"text-primary":"text-navy-35"}`,children:p?"on":"off"})]}),e.jsx(se,{isOn:!!p,toggle:R})]})})}),e.jsx("section",{id:"대기자 목록",className:"flex flex-col w-full",children:e.jsxs("div",{className:"relative w-full",children:[e.jsx("div",{className:"mask-fade-right",children:e.jsx("div",{className:"overflow-x-auto scrollbar-hide pr-12",children:e.jsx("div",{className:"flex flex-wrap whitespace-nowrap [@media(max-width:431px)]:flex-nowrap -mr-5",children:$.map(({label:s,count:o})=>e.jsx(ne,{label:s,active:g===s,onClick:()=>y(s),count:s==="전체"?void 0:o},s))})})}),e.jsx("button",{type:"button","aria-label":"새로고침",onClick:Q,disabled:h,"aria-busy":h,className:`absolute right-0 top-1/2 -translate-y-1/2 z-10\r
                 cursor-pointer [@media(max-width:431px)]:hidden`,children:e.jsx("img",{src:X,alt:"",className:`block ${h?"animate-[spin_0.6s_linear_1]":""}`})})]})}),e.jsx("div",{className:"w-full grid grid-cols-1 gap-[10px] md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4  [@media(max-width:431px)]:place-items-center",children:K.map(s=>{const o=new Date(s.requestedAt);return console.log(s,"웨이팅 카드 정보"),e.jsx(de,{number:s.id,time:o.toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit",hour12:!1}),waitMinutes:Math.floor((Date.now()-o.getTime())/6e4),peopleCount:s.peopleCount,name:s.name,phoneNumber:s.phoneNumber,status:s.status,requestedAt:s.requestedAt,calledAt:s.calledAt,confirmedAt:s.updatedAt,cancelledAt:s.updatedAt,isNoShow:t.includes(s.id),onCall:()=>U(s.id,s.userId),onEnter:()=>z(s.id,s.userId),onClose:()=>V(s.id,s.userId),onDelete:()=>{A(s),m(!0)},onNoShow:()=>P(s.id)},s.userId+"-"+s.requestedAt)})}),r&&w&&e.jsx(ee,{mode:null,onCancel:()=>m(!1),onConfirm:()=>{V(w.id,w.userId),m(!1),A(null)}})]})};export{Ae as default};
